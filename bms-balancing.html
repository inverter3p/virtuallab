<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Battery Balancing Circuit Tutorial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .step-card {
            transition: all 0.5s ease-in-out;
            transform-style: preserve-3d;
        }
        .step-content {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .battery-cell-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            min-height: 250px;
            padding: 20px;
            border-radius: 12px;
            background-color: #f0f4f8;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        .battery-cell {
            width: 60px;
            height: 200px; /* Set a fixed height for the cell casing */
            background-color: #aecaf0; /* This is the "empty" part of the cell */
            border-radius: 12px 12px 0 0; /* More rounded corners */
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10;
            overflow: hidden; /* Hide the part of the level that goes beyond the casing */
        }
        .battery-cell::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background-color: #94a3b8; /* slate-400 */
            border-radius: 5px 5px 0 0;
        }
        /* Removed the ::after pseudo-element that created the '+' sign */
        .battery-level {
            width: 100%;
            position: absolute; /* Position the level inside the cell casing */
            bottom: 0;
            left: 0;
            border-radius: 0; /* Casing has the radius now */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 600;
            overflow: hidden;
            /* Animate the height of the colored level */
            transition: height 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
        .voltage-text {
            padding-top: 10px;
        }
        .resistor {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            color: #f56565; /* Red color for heat */
            z-index: 20;
        }
        .resistor.active {
            opacity: 1;
            transform: translateX(-50%) scale(1.1);
            animation: glow 1.5s infinite alternate;
        }
        
        #energy-transfer-path {
            position: absolute;
            stroke: #2563eb;
            stroke-width: 4px;
            fill: none;
            stroke-dasharray: 10 5;
            animation: dash 1s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        @keyframes dash {
            to { stroke-dashoffset: -15; }
        }

        @keyframes glow {
            from { text-shadow: 0 0 5px #f56565, 0 0 10px #f56565; }
            to { text-shadow: 0 0 10px #ef4444, 0 0 20px #ef4444; }
        }
        .quiz-option {
            transition: background-color 0.2s;
        }
         .quiz-option.correct {
            background-color: #48bb78; /* green-500 */
            color: white;
        }
        .quiz-option.incorrect {
            background-color: #f56565; /* red-500 */
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <div id="tutorial-container" class="bg-white rounded-xl shadow-2xl p-6 md:p-8">
            <h1 class="text-3xl font-bold text-center text-gray-900 mb-2">EV Battery Balancing Interactive Guide</h1>
            <p class="text-center text-gray-600 mb-6">Learn how a Battery Management System (BMS) keeps EV batteries healthy.</p>
            
            <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-2.5 mb-8">
                <div id="progress-indicator" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 20%"></div>
            </div>

            <!-- Step 1: Introduction -->
            <div id="step-1" class="step-card">
                <div class="step-content">
                    <h2 class="text-2xl font-semibold mb-4">What's the Big Deal with Battery Balancing?</h2>
                    <p class="mb-4">An EV battery pack isn't one giant battery. It's a chain of hundreds or even thousands of individual battery cells working together.</p>
                    <p class="mb-4">For the pack to be safe and efficient, all these cells must have roughly the same voltage. But over time, they can become <strong class="text-red-600">unbalanced</strong>.</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800">
                        <p>This tutorial will show you <strong class="font-semibold">why</strong> this happens and <strong class="font-semibold">how</strong> the BMS fixes it using two main methods: <strong class="font-semibold">passive</strong> and <strong class="font-semibold">active balancing</strong>.</p>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: The Problem -->
            <div id="step-2" class="step-card hidden">
                <div class="step-content">
                    <h2 class="text-2xl font-semibold mb-4">The Problem: Unbalanced Cells</h2>
                    <p class="mb-4">Imagine a battery pack with four cells. Ideally, they all charge and discharge at the same rate. But due to tiny manufacturing differences, temperature, and age, they drift apart.</p>
                    <div id="unbalanced-cells-display" class="battery-cell-container mb-4"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="bg-red-50 border border-red-200 p-3 rounded-lg"><h3 class="font-bold text-red-700">Danger of Overcharging</h3><p class="text-red-600">If we keep charging this pack, Cell 3 will overcharge before Cell 2 is full. This can damage the cell and is a major safety risk!</p></div>
                        <div class="bg-yellow-50 border border-yellow-300 p-3 rounded-lg"><h3 class="font-bold text-yellow-700">Problem of Underutilization</h3><p class="text-yellow-600">When discharging, the whole pack is forced to stop when Cell 2 is empty, even though other cells still have energy. This reduces the car's range.</p></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Passive Balancing -->
            <div id="step-3" class="step-card hidden">
                <div class="step-content">
                    <h2 class="text-2xl font-semibold mb-4">Method 1: Passive Balancing</h2>
                    <p class="mb-4">This is the simpler method. The BMS "bleeds off" excess energy from high-voltage cells by converting it into a tiny amount of heat through a resistor.</p>
                    <div class="my-4 flex justify-center bg-gray-100 p-4 rounded-lg border"><img src="https://www.eetimes.com/wp-content/uploads/media-1052974-f7.gif" alt="Passive Balancing Circuit Diagram" class="rounded-lg shadow-sm w-full max-w-md" onerror="this.parentElement.style.display='none'"></div>
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg border mt-4"><svg class="w-12 h-12 text-gray-500 mr-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><div><h3 class="font-bold text-gray-800">How It Works:</h3><p class="text-gray-700">A small switch (a MOSFET) connects a resistor across the high-voltage cell. This creates a path for a small amount of current to flow, converting excess electrical energy into heat until the voltages match the other cells.</p></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4"><div class="bg-green-50 border border-green-200 p-3 rounded-lg"><h3 class="font-bold text-green-700">Advantage</h3><p class="text-green-600">Simple, cheap, and reliable.</p></div><div class="bg-red-50 border border-red-200 p-3 rounded-lg"><h3 class="font-bold text-red-700">Disadvantage</h3><p class="text-red-600">Wastes energy as heat and can only balance downwards (removing energy).</p></div></div>
                </div>
            </div>
            
            <!-- Step 4: Interactive Simulation (Passive) -->
            <div id="step-4" class="step-card hidden">
                 <div class="step-content">
                    <h2 class="text-2xl font-semibold mb-4">Simulation: Passive Balancing</h2>
                    <p class="mb-4">This simulation shows passive balancing in action. The BMS has identified that Cell 3 has the highest voltage. Click the button to start bleeding off its excess energy.</p>
                    <div id="passive-simulation-cells-display" class="battery-cell-container mb-4"></div>
                    <div class="text-center"><button id="passive-balance-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-400">Balance Cells</button><p id="passive-simulation-status" class="mt-3 text-gray-600 h-5"></p></div>
                </div>
            </div>

            <!-- Step 5: Active Balancing -->
            <div id="step-5" class="step-card hidden">
                 <div class="step-content">
                    <h2 class="text-2xl font-semibold mb-4">Method 2: Active Balancing</h2>
                    <p class="mb-4">This is a more advanced and efficient method. Instead of wasting excess energy as heat, an active balancing system <strong class="text-green-600">transfers energy</strong> from the cells with higher voltage to the cells with lower voltage.</p>
                    <div class="my-4 flex justify-center bg-gray-100 p-4 rounded-lg border"><img src="https://media.monolithicpower.com/wysiwyg/Articles/Fig_5-_Bidirectional_Buck_and_Boost_Active_Balancer.jpg" alt="Active Balancing Circuit Diagram" class="rounded-lg shadow-sm w-full max-w-md" onerror="this.parentElement.style.display='none'"></div>
                    <div class="flex items-center bg-gray-50 p-4 rounded-lg border mt-4"><svg class="w-12 h-12 text-blue-500 mr-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path><path d="M4 4v5h5M20 20v-5h-5"></path><path d="M4 9a8 8 0 0111.45-6.811"></path><path d="M20 15a8 8 0 01-11.45 6.811"></path></svg><div><h3 class="font-bold text-gray-800">How It Works:</h3><p class="text-gray-700">Using components like inductors or capacitors, the circuit takes energy from the highest cell, stores it momentarily, and then transfers it to the lowest cell. It's like a tiny, high-speed bucket brigade for energy!</p></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4"><div class="bg-green-50 border border-green-200 p-3 rounded-lg"><h3 class="font-bold text-green-700">Advantage</h3><p class="text-green-600">Very efficient, as it redistributes energy instead of wasting it. This can lead to slightly better range and faster charging.</p></div><div class="bg-red-50 border border-red-200 p-3 rounded-lg"><h3 class="font-bold text-red-700">Disadvantage</h3><p class="text-red-600">Much more complex and expensive due to extra components.</p></div></div>
                </div>
            </div>

            <!-- Step 6: Interactive Simulation (Active) -->
            <div id="step-6" class="step-card hidden">
                 <div class="step-content">
                    <h2 class="text-2xl font-semibold mb-4">Simulation: Active Balancing</h2>
                    <p class="mb-4">This simulation shows active balancing. The BMS will move energy from the highest cell (Cell 3) to the lowest cell (Cell 2) until they are all balanced. Watch the energy transfer path!</p>
                    <div id="active-simulation-cells-display" class="battery-cell-container mb-4">
                        <svg id="energy-transfer-svg" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:15;">
                            <path id="energy-transfer-path"></path>
                        </svg>
                    </div>
                    <div class="text-center"><button id="active-balance-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300 disabled:bg-gray-400">Balance Cells</button><p id="active-simulation-status" class="mt-3 text-gray-600 h-5"></p></div>
                </div>
            </div>
            
            <!-- Step 7: Real-World Example -->
            <div id="step-7" class="step-card hidden">
                 <div class="step-content">
                    <h2 class="text-2xl font-semibold mb-4">Real-World Implementation</h2>
                    <p class="mb-4">In a real BMS, active balancing is managed by specialized Integrated Circuits (ICs). These ICs contain all the complex switching logic to efficiently move energy between cells or groups of cells.</p>
                    <p class="mb-4">Below is a typical application circuit showing how such an IC is connected within a battery pack.</p>
                    <div class="my-4 flex justify-center bg-gray-100 p-4 rounded-lg border">
                        <img src="https://media.monolithicpower.com/wysiwyg/Articles/Fig_7-_Typical_Application_Circuit_in_an_ESS.jpg" alt="Active Balancing IC Application Circuit" class="rounded-lg shadow-sm w-full" onerror="this.parentElement.style.display='none'">
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-blue-800">
                        <p>This level of integration makes modern, efficient active balancing possible in a compact and reliable form factor. For a deeper dive into the circuit, check out the source article.</p>
                        <a href="https://www.monolithicpower.com/en/learning/resources/active-balancing-how-it-works-and-its-advantages?srsltid=AfmBOoqsO8VznXUIaD9CBKxYHDK1pSUmoXP_QBX44_pTPuD9XYHI94XI" target="_blank" rel="noopener noreferrer" class="font-semibold text-blue-600 hover:underline mt-2 inline-block">Learn More at Monolithic Power Systems &rarr;</a>
                    </div>
                </div>
            </div>

            <!-- Step 8: Quiz -->
            <div id="step-8" class="step-card hidden">
                <div class="step-content">
                    <h2 class="text-2xl font-semibold mb-4">Check Your Knowledge</h2>
                    <p class="mb-6">Let's see what you've learned. Answer the questions below.</p>
                    <div id="quiz-container" class="bg-gray-50 p-6 rounded-lg border">
                         <p id="quiz-question" class="font-semibold text-lg mb-4"></p>
                         <div id="quiz-options" class="space-y-3"></div>
                         <p id="quiz-feedback" class="mt-4 font-medium h-6"></p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="flex justify-between items-center mt-8 pt-6 border-t">
                <button id="prev-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400 transition disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                <span id="step-counter" class="text-sm text-gray-500"></span>
                <button id="next-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const steps = document.querySelectorAll('.step-card');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const stepCounter = document.getElementById('step-counter');
    const progressIndicator = document.getElementById('progress-indicator');
    
    // Simulation elements
    const passiveBalanceBtn = document.getElementById('passive-balance-btn');
    const passiveSimulationStatus = document.getElementById('passive-simulation-status');
    const activeBalanceBtn = document.getElementById('active-balance-btn');
    const activeSimulationStatus = document.getElementById('active-simulation-status');
    const energyPath = document.getElementById('energy-transfer-path');

    let currentStep = 1;
    const totalSteps = steps.length;
    const initialCellVoltages = [3.85, 3.70, 4.15, 3.95];
    let cellVoltages = [...initialCellVoltages];
    
    const quizData = [
        { question: "How does passive balancing remove excess energy from a cell?", options: ["It moves the energy to a neighboring cell.", "It converts the energy into heat using a resistor.", "It sends the energy back to the charger.", "It stores the energy in a capacitor."], answer: 1 },
        { question: "What is the main advantage of active balancing over passive balancing?", options: ["It's simpler and cheaper.", "It balances cells much faster.", "It is more energy-efficient because it transfers energy.", "It works better in cold weather."], answer: 2 },
        { question: "What is a major downside of passive balancing?", options: ["It is very expensive to implement.", "It can only be done when the EV is moving.", "It wastes energy as heat.", "It makes the battery pack heavier."], answer: 2 },
        { question: "If an active balancer moves energy, where does it typically send it?", options: ["To the battery pack's cooling system.", "From the highest voltage cell to the lowest voltage cell.", "Out of the battery pack entirely.", "To the single strongest cell in the pack."], answer: 1 },
    ];
    let currentQuizQuestion = 0;
    let simulationInterval;
    
    function updateUI() {
        clearInterval(simulationInterval);
        cellVoltages = [...initialCellVoltages];

        steps.forEach((step, index) => step.classList.toggle('hidden', index + 1 !== currentStep));

        prevBtn.disabled = currentStep === 1;
        nextBtn.disabled = currentStep === totalSteps;
        stepCounter.textContent = `Step ${currentStep} of ${totalSteps}`;
        progressIndicator.style.width = `${((currentStep -1) / (totalSteps-1)) * 100}%`;
        
        if (currentStep === 2) renderCells('unbalanced-cells-display', cellVoltages);
        else if (currentStep === 4) {
            passiveBalanceBtn.disabled = false;
            passiveSimulationStatus.textContent = '';
            renderCells('passive-simulation-cells-display', cellVoltages);
        } else if (currentStep === 6) {
            activeBalanceBtn.disabled = false;
            activeSimulationStatus.textContent = '';
            energyPath.style.opacity = '0';
            renderCells('active-simulation-cells-display', cellVoltages);
        } else if (currentStep === 8) { // Changed from 7 to 8
            currentQuizQuestion = 0;
            loadQuizQuestion();
        }
    }

    function renderCells(containerId, voltages, options = {}) {
        const container = document.getElementById(containerId);
        container.querySelectorAll('.battery-cell').forEach(c => c.remove()); // Clear only cells
        const minVoltage = 3.2;
        const maxVoltage = 4.2;

        voltages.forEach((voltage, index) => {
            const percentage = ((voltage - minVoltage) / (maxVoltage - minVoltage)) * 100;
            const cell = document.createElement('div');
            cell.className = 'battery-cell';
            cell.id = `${containerId}-cell-${index}`;
            
            const level = document.createElement('div');
            level.className = 'battery-level';
            level.style.height = `${percentage}%`; // Set height of the colored level
            
            let bgColor;
            if (voltage > 4.1) bgColor = '#ef4444'; // Keep red for danger
            else if (voltage > 3.9) bgColor = '#f59e0b'; // Keep yellow for warning
            else bgColor = '#465f94'; // Use slate-500 for normal
            level.style.backgroundColor = bgColor;
            level.innerHTML = `<span class="voltage-text">${voltage.toFixed(2)}V</span><span class="pb-1 text-sm opacity-80">Cell ${index + 1}</span>`;
            
            if (options.showResistors) {
                const resistor = document.createElement('div');
                resistor.className = 'resistor';
                resistor.id = `resistor-${containerId}-${index}`;
                resistor.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM10.24 5.2a.75.75 0 011.06 0l4.25 4.25a.75.75 0 010 1.06l-4.25 4.25a.75.75 0 01-1.06-1.06L13.94 12 10.24 8.31a.75.75 0 010-1.06z" clip-rule="evenodd" transform="rotate(90 12 12)" /></svg>`;
                cell.appendChild(resistor);
            }
            cell.appendChild(level);
            container.appendChild(cell);
        });
    }

    function startPassiveBalancing() {
        passiveBalanceBtn.disabled = true;
        passiveSimulationStatus.textContent = 'Balancing in progress...';
        const targetVoltage = Math.min(...cellVoltages);
        
        simulationInterval = setInterval(() => {
            let maxVoltage = -1, maxIndex = -1;
            cellVoltages.forEach((v, i) => { if (v > maxVoltage) { maxVoltage = v; maxIndex = i; } });
            
            document.querySelectorAll(`#passive-simulation-cells-display .resistor`).forEach(r => r.classList.remove('active'));

            if (maxVoltage > targetVoltage + 0.01) {
                document.getElementById(`resistor-passive-simulation-cells-display-${maxIndex}`)?.classList.add('active');
                cellVoltages[maxIndex] = Math.max(targetVoltage, cellVoltages[maxIndex] - 0.01);
            }
            
            renderCells('passive-simulation-cells-display', cellVoltages, { showResistors: true });
            
            if (cellVoltages.every(v => v <= targetVoltage + 0.01)) {
                clearInterval(simulationInterval);
                document.querySelectorAll(`#passive-simulation-cells-display .resistor`).forEach(r => r.classList.remove('active'));
                passiveSimulationStatus.innerHTML = '<span class="text-green-600 font-semibold">Balancing Complete!</span>';
                cellVoltages = cellVoltages.map(() => targetVoltage);
                renderCells('passive-simulation-cells-display', cellVoltages, { showResistors: true });
            }
        }, 100);
    }
    
    function startActiveBalancing() {
        activeBalanceBtn.disabled = true;
        activeSimulationStatus.textContent = 'Transferring energy...';
        
        simulationInterval = setInterval(() => {
            let maxV = -1, maxI = -1, minV = 5, minI = -1;
            cellVoltages.forEach((v, i) => {
                if(v > maxV) { maxV = v; maxI = i; }
                if(v < minV) { minV = v; minI = i; }
            });
            
            const highCellEl = document.getElementById(`active-simulation-cells-display-cell-${maxI}`);
            const lowCellEl = document.getElementById(`active-simulation-cells-display-cell-${minI}`);
            
            if (maxV > minV + 0.02 && highCellEl && lowCellEl) {
                const containerRect = document.getElementById('active-simulation-cells-display').getBoundingClientRect();
                const highRect = highCellEl.getBoundingClientRect();
                const lowRect = lowCellEl.getBoundingClientRect();

                const startX = highRect.left - containerRect.left + highRect.width / 2;
                const startY = highRect.top - containerRect.top - 15;
                const endX = lowRect.left - containerRect.left + lowRect.width / 2;
                const endY = lowRect.top - containerRect.top - 15;
                const controlY = Math.min(startY, endY) - 50;

                energyPath.setAttribute('d', `M ${startX} ${startY} Q ${(startX+endX)/2} ${controlY}, ${endX} ${endY}`);
                energyPath.style.opacity = '1';

                cellVoltages[maxI] -= 0.005;
                cellVoltages[minI] += 0.005;
            } else {
                 energyPath.style.opacity = '0';
            }
            
            renderCells('active-simulation-cells-display', cellVoltages);
            
            const isBalanced = (Math.max(...cellVoltages) - Math.min(...cellVoltages)) < 0.02;
            if (isBalanced) {
                clearInterval(simulationInterval);
                energyPath.style.opacity = '0';
                activeSimulationStatus.innerHTML = '<span class="text-green-600 font-semibold">Balancing Complete!</span>';
                const avgVoltage = cellVoltages.reduce((a, b) => a + b, 0) / cellVoltages.length;
                cellVoltages = cellVoltages.map(() => avgVoltage);
                renderCells('active-simulation-cells-display', cellVoltages);
            }
        }, 150);
    }

    function loadQuizQuestion() {
        const q = quizData[currentQuizQuestion];
        if (!q) {
            document.getElementById('quiz-container').innerHTML = `<h3 class="text-2xl font-bold text-green-600 text-center">Congratulations!</h3><p class="text-center mt-2">You've completed the tutorial on EV battery balancing.</p>`;
            return;
        }
        document.getElementById('quiz-question').textContent = q.question;
        const optionsEl = document.getElementById('quiz-options');
        optionsEl.innerHTML = '';
        document.getElementById('quiz-feedback').textContent = '';
        q.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'w-full text-left p-3 border-2 rounded-lg quiz-option hover:bg-gray-100';
            button.textContent = option;
            button.onclick = () => handleQuizAnswer(index);
            optionsEl.appendChild(button);
        });
    }

    function handleQuizAnswer(selectedIndex) {
        const correctIndex = quizData[currentQuizQuestion].answer;
        const options = document.querySelectorAll('.quiz-option');
        options.forEach(btn => btn.disabled = true);
        
        if (selectedIndex === correctIndex) {
            options[selectedIndex].classList.add('correct');
            document.getElementById('quiz-feedback').textContent = 'Correct! Well done.';
            document.getElementById('quiz-feedback').className = 'mt-4 font-medium h-6 text-green-600';
            currentQuizQuestion++;
            setTimeout(loadQuizQuestion, 1500);
        } else {
            options[selectedIndex].classList.add('incorrect');
            options[correctIndex].classList.add('correct');
            document.getElementById('quiz-feedback').textContent = 'Not quite. The correct answer is highlighted.';
            document.getElementById('quiz-feedback').className = 'mt-4 font-medium h-6 text-red-600';
            setTimeout(loadQuizQuestion, 2500);
        }
    }

    nextBtn.addEventListener('click', () => { if (currentStep < totalSteps) { currentStep++; updateUI(); } });
    prevBtn.addEventListener('click', () => { if (currentStep > 1) { currentStep--; updateUI(); } });
    passiveBalanceBtn.addEventListener('click', startPassiveBalancing);
    activeBalanceBtn.addEventListener('click', startActiveBalancing);

    updateUI();
});
</script>
</body>
</html>

